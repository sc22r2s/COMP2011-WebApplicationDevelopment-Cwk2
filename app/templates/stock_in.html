{% extends 'base.html' %}

{% block content %}
<div class="forms">
  <form action="#" method="post" id="form">
    <div class="form-group">
      <label for="ProductCodeInput">Product Code</label>
      <input
        type="text"
        class="form-control"
        id="ProductCodeInput"
        placeholder="Enter Product Code"
      />
    </div>
    <div id="ProductCodeInputHelp" class="form-text">Press enter after you input the product code.</div>

    <div class="form-group">
        <label for="ProductIdDisplay">Product ID
        <input
          type="text"
          readonly
          class="form-control"
          id="ProductIdDisplay"
          placeholder="ID of the product"
        />
        </label>

        <label for="ProductNameDisplay">Product Name
        <input
        type="text"
        readonly
        class="form-control"
        id="ProductNameDisplay"
        placeholder="Name of the product"
        />
        </label>

        <label for="ProductDescriptionDisplay">Product Description
        <input
        type="text"
        readonly
        class="form-control"
        id="ProductDescriptionDisplay"
        placeholder="Description of the product"
        />
        </label>

        <label for="ProductRateDisplay">Product Rate
        <input
        type="text"
        readonly
        class="form-control"
        id="ProductRateDisplay"
        placeholder="Rate of the product"
        />
        </label>
    </div>

    <div class="form-group">
        <label for="ProductQuantityInput">Product Quantity
        <input
        type="text"
        class="form-control"
        id="ProductQuantityInput"
        placeholder="Enter Product Quantity"
        />
        </label>
    
        <br>
        <button type="submit" class="form-group btn btn-light" id="submit-product-btn">Add Product To Batch</button>
    </div>
  </form>
</div>

<br>

<table class="table table-striped table-bordered table-hover table-sm">
    <thead>
    <tr>
        <th scope="col">Product ID</th>
        <th scope="col">Product Code</th>
        <th scope="col">Product Name</th>
        <th scope="col">Quantity</th>
    </tr>
    </thead>

    <tbody id="product-row">

    </tbody>
</table>

<button type="submit" class="btn btn-light" id="submit-batch-btn">Save Batch</button>

<script>
    var batch = {"productId": [], "quantity": []}

  $("#ProductCodeInput").keydown(function (event) {

    if (event.keyCode === 13) {
        event.preventDefault();
        var code = $("#ProductCodeInput").val();

        $.ajax({
            type: 'GET',
            url: '/ajax/display-product-detail',
            data: { productCode: code },    
            success: function(data, status, xhr) {
                if (data.hasOwnProperty("error") ) {
                    alert("Invalid product code");
                } else {
                    // Add data to the form
                    $("#ProductIdDisplay").val(data.id)
                    $("#ProductNameDisplay").val(data.productName);
                    $("#ProductDescriptionDisplay").val(data.description);
                    $("#ProductRateDisplay").val(data.rate);
                }
            },
            error: function (jqXhr, textStatus, errorMessage) {
                // error callback
                alert(errorMessage);
            }
        });
    }

  });

  $("form").on("submit", function (event) {
    event.preventDefault();
    if ($("#ProductNameDisplay").val() === "") { // Check if product code has been entered       
        alert("Enter product code");
    } else if ($("#ProductQuantityInput").val() === "") { // Check if product quantity has been entered
        alert("Enter product quantity");
    } else if (!(parseInt($("#ProductQuantityInput").val()))) { // Check if product quantity is an integer
        alert("Invalid product quantity");         
    } else if (batch["productId"].includes(parseInt($("#ProductIdDisplay").val()))) { // Check if product already in batch
        alert("Product already added in this batch");
    } else {
        // Append data in the table
        $('#product-row').append("<tr><td>" + $("#ProductIdDisplay").val() + "</td><td>"+$("#ProductCodeInput").val()+"</td><td>"+$("#ProductNameDisplay").val()+"</td><td>" + $("#ProductQuantityInput").val() + "</td></tr>");
        
        batch["productId"].push(parseInt($("#ProductIdDisplay").val()));
        batch["quantity"].push(parseInt($("#ProductQuantityInput").val()));

        console.log(batch["productId"]);

        // Clear data from form after appending data in table
        $("#ProductCodeInput").val("");
        $("#ProductIdDisplay").val("");
        $("#ProductNameDisplay").val("");
        $("#ProductDescriptionDisplay").val("");
        $("#ProductRateDisplay").val("");
        $("#ProductQuantityInput").val("");
    }

  });
</script>
{% endblock %}
