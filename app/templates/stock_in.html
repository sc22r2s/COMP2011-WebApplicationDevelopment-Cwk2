{% extends 'base.html' %}

{% block content %}
<label for="BatchCodeInput">Batch Code
  <input
    type="text"
    class="form-control"
    id="BatchCodeInput"
    placeholder="Batch Code"
  />
</label>

<label for="BatchCodeInput">Batch In or Out
  <select class="form-select" aria-label="Stock in or out" id="BatchInOutDropdown">
    <option selected value="0">Batch In</option>
    <option value="1">Batch Out</option>
  </select>
</label>


<hr>

<div class="forms">
  <form action="" method="post" id="form">
    <div class="form-group">
      <label for="ProductCodeInput">Product Code</label>
      <input
        type="text"
        class="form-control"
        id="ProductCodeInput"
        placeholder="Enter Product Code"
      />
    </div>
    <div id="ProductCodeInputHelp" class="form-text">Press enter after you input the product code.</div>

    <div class="form-group">
        <label for="ProductIdDisplay">Product ID
        <input
          type="text"
          readonly
          class="form-control"
          id="ProductIdDisplay"
          placeholder="ID of the product"
        />
        </label>

        <label for="ProductNameDisplay">Product Name
        <input
        type="text"
        readonly
        class="form-control"
        id="ProductNameDisplay"
        placeholder="Name of the product"
        />
        </label>

        <label for="ProductDescriptionDisplay">Product Description
        <input
        type="text"
        readonly
        class="form-control"
        id="ProductDescriptionDisplay"
        placeholder="Description of the product"
        />
        </label>

        <label for="ProductRateDisplay">Product Rate
        <input
        type="text"
        readonly
        class="form-control"
        id="ProductRateDisplay"
        placeholder="Rate of the product"
        />
        </label>
    </div>

    <div class="form-group">
        <label for="ProductQuantityInput">Product Quantity
        <input
        type="text"
        class="form-control"
        id="ProductQuantityInput"
        placeholder="Enter Product Quantity"
        />
        </label>
    
        <br>
        <button type="submit" class="form-group btn btn-light" id="submit-product-btn">Add Product To Batch</button>
    </div>
  </form>
</div>

<br>

<table class="table table-striped table-bordered table-hover table-sm">
    <thead>
    <tr>
        <th scope="col">Product ID</th>
        <th scope="col">Product Code</th>
        <th scope="col">Product Name</th>
        <th scope="col">Quantity</th>
    </tr>
    </thead>

    <tbody id="product-row">

    </tbody>
</table>

<button type="submit" class="btn btn-light" id="submit-batch-btn" onClick="saveBatch()">Save Batch</button>

<script>
    var batch = {"batchCode": "", "batchDirection": "0", "productDetail": []};
    var batchProducts = [];

  $("#ProductCodeInput").keydown(function (event) {

    if (event.keyCode === 13) {
        event.preventDefault();
        var code = $("#ProductCodeInput").val();

        $.ajax({
            type: 'GET',
            url: '/ajax/display-product-detail',
            data: { productCode: code },    
            success: function(data, status, xhr) {
                if (data.hasOwnProperty("error") ) {
                    alert("Invalid product code");
                } else {
                    // Add data to the form
                    $("#ProductIdDisplay").val(data.id)
                    $("#ProductNameDisplay").val(data.productName);
                    $("#ProductDescriptionDisplay").val(data.description);
                    $("#ProductRateDisplay").val(data.rate);
                    // Next cursor destination
                    $("#ProductQuantityInput").focus();
                }
            },
            error: function (jqXhr, textStatus, errorMessage) {
                // error callback
                alert(errorMessage);
            }
        });
    }

  });

  $("form").on("submit", function (event) {
    event.preventDefault();
    if ($("#ProductNameDisplay").val() === "") { // Check if product code has been entered       
        alert("Enter product code");
    } else if ($("#ProductQuantityInput").val() === "") { // Check if product quantity has been entered
        alert("Enter product quantity");
    } else if (!(parseInt($("#ProductQuantityInput").val()))) { // Check if product quantity is an integer
        alert("Invalid product quantity");         
    } else if (batchProducts.includes(parseInt($("#ProductIdDisplay").val()))) { // Check if product already in batch
        alert("Product already added in this batch");
    } else {
        // Append data in the table
        $('#product-row').append("<tr><td>" + $("#ProductIdDisplay").val() + "</td><td>"+$("#ProductCodeInput").val()+"</td><td>"+$("#ProductNameDisplay").val()+"</td><td>" + $("#ProductQuantityInput").val() + "</td></tr>");
        
        batch["productDetail"].push({"productId": parseInt($("#ProductIdDisplay").val()), "quantity": parseInt($("#ProductQuantityInput").val())});
        batchProducts.push(parseInt($("#ProductIdDisplay").val()));

        // Clear data from form after appending data in table
        $("#ProductCodeInput").val("");
        $("#ProductIdDisplay").val("");
        $("#ProductNameDisplay").val("");
        $("#ProductDescriptionDisplay").val("");
        $("#ProductRateDisplay").val("");
        $("#ProductQuantityInput").val("");

        // Next cursor destination
        $("#ProductCodeInput").focus();
    }

  });

  function saveBatch() {
    if (batchProducts.length === 0){
      alert("No product added");
    } else if ($("#BatchCodeInput").val() === ""){
      alert("Batch code must be provided");
    } else {
      batch["batchCode"] = $("#BatchCodeInput").val()
      batch["batchDirection"] = $("#BatchInOutDropdown").val()

      $.ajax({
        type: 'GET',
        url: '/ajax/add-batch',
        data: { batch: JSON.stringify(batch) }, 
        success: function(data, status, xhr) {
          if (data.hasOwnProperty("error") ) {
            alert("Batch can not be added");
          } else {
            alert("Batch added successfully")
            location.reload()
          }
        },
        error: function (jqXhr, textStatus, errorMessage) {
            // error callback
            alert(errorMessage);
        }
    });
    }
  }
</script>
{% endblock %}
